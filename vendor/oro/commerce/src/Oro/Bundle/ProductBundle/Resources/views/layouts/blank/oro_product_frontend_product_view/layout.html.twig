{# Product view Layout START #}
{% block _product_view_container_widget %}
    {% import 'OroProductBundle::image_macros.html.twig' as Image %}

    {% set productImage = product.imagesByType('listing').first.image|default(null) %}
    {% set productImageUrl = Image.url(productImage, 'product_small') %}

    {% set modelAttr = product.jsonSerialize() %}
    {% set modelAttr = modelAttr|merge({
        'imageUrl': productImageUrl,
        'name': product.names|localized_value|e
    }) %}

    {% if parentProduct is not null %}
        {% set modelAttr = modelAttr|merge({parentProduct: parentProduct.id}) %}
    {% endif %}
    {% set attr = layout_attr_defaults(attr, {
        'data-page-component-module': 'oroui/js/app/components/view-component',
        '~data-page-component-options': {
            view: 'oroproduct/js/app/views/base-product-view',
            modelAttr: modelAttr
        },
        'itemscope': '',
        'itemtype': 'http://schema.org/Product',
        'data-layout': 'separate',
        'data-role': 'product-item',
        '~class': ' product-view ' ~ productTheme|default('default') ~ '-theme'
    }) %}

    <div {{ block('block_attributes') }}>
        {{ block_widget(block) }}
    </div>
{% endblock %}

{% block _product_view_primary_wrapper_widget %}
    {% set attr = layout_attr_defaults(attr, {
        '~class': ' product-view__primary-wrapper'
    }) %}

    <div {{ block('block_attributes') }}>
        {{ block_widget(block) }}
    </div>
{% endblock %}

{% block _product_view_primary_container_widget %}
    {% set attr = layout_attr_defaults(attr, {
        '~class': ' product-view__primary'
    }) %}

    <div {{ block('block_attributes') }}>
        {{ block_widget(block) }}
    </div>
{% endblock %}

{% block _product_view_aside_container_widget %}
    {% set attr = layout_attr_defaults(attr, {
        '~class': ' product-view__aside'
    }) %}

    <div {{ block('block_attributes') }}>
        {{ block_widget(block) }}
    </div>
{% endblock %}

{% block _product_view_main_container_widget %}
    {% set attr = layout_attr_defaults(attr, {
        '~class': ' product-view__main'
    }) %}

    <div {{ block('block_attributes') }}>
        {{ parent_block_widget(block) }}
    </div>
{% endblock %}

{% block _product_view_content_container_widget %}
    {% set attr = layout_attr_defaults(attr, {
        '~class': ' product-view__content'
    }) %}

    <div {{ block('block_attributes') }}>
        {{ block_widget(block) }}
    </div>
{% endblock %}

{% block _product_view_specification_container_widget %}
    {% if block.children is not empty %}
        {% set attr = layout_attr_defaults(attr, {
            '~class': ' product-view__specification',
            'data-role': 'layout-subtree-loading-container'
        }) %}
        {% set children = block_widget(block) %}

        {% if children|trim|length %}
            <div {{ block('block_attributes') }}>
                {{ children|raw }}
            </div>
        {% endif %}
    {% endif %}
{% endblock %}

{% block _product_view_description_container_widget %}
    {% set attr = layout_attr_defaults(attr, {
        '~class': ' product-view__description',
        'itemprop': 'description'
    }) %}

    <div {{ block('block_attributes') }}>
        {{ block_widget(block) }}
    </div>
{% endblock %}

{% block _product_view_attribute_group_general_attribute_localized_fallback_descriptions_widget %}
    {% set description = translated_value|trim %}
    {% if description %}
    {% set attr = layout_attr_defaults(attr, {
        '~class': ' collapse-view collapse-view--overflow',
        '~data-page-component-viewport': {
            viewport: {
                maxScreenType: 'tablet',
            },
            widgetModule: 'oroui/js/widget/collapse-widget',
            animationSpeed: 0,
            checkOverflow: true,
            open: false
        }
    }) %}

    <div {{ block('block_attributes') }}>
        <div class="collapse-view__container cms-typography" data-collapse-container>
            {%- if translated_value.wysiwygStyle|length -%}
                {%- spaceless -%}
                    <style type="text/css">{{ translated_value.wysiwygStyle|render_content }}</style>
                {%- endspaceless -%}
            {%- endif -%}
            {{ description|render_content }}
        </div>
        <a href="#" class="collapse-view__trigger" data-collapse-trigger>
            <i class="collapse-view__trigger-icon fa-chevron-down"></i>
        </a>
    </div>
    {% endif %}
{% endblock %}

{% block _product_view_brand_container_widget %}
    {% if block.children is not empty %}
        {% set attr = layout_attr_defaults(attr, {
            '~class': ' product-view__brand'
        }) %}

        <div {{ block('block_attributes') }}>
            {{ block_widget(block) }}
        </div>
    {% endif %}
{% endblock %}

{% block _product_view_attribute_group_general_widget %}
    {% if block.children is not empty %}
        {% set attr = layout_attr_defaults(attr, {
            '~class': ' product-view__general'
        }) %}

        <div {{ block('block_attributes') }}>
            {{ block_widget(block) }}
        </div>
    {% endif %}
{% endblock %}

{% block _product_view_additional_container_widget %}
    {% set attr = layout_attr_defaults(attr, {
        '~class': ' product-view__additional'
    }) %}

    <div {{ block('block_attributes') }}>
        {{ block_widget(block) }}
    </div>
{% endblock %}
{# Product view Layout START #}

{% block _product_view_attribute_group_general_attribute_localized_fallback_names_widget %}
    {% set attr = layout_attr_defaults(attr, {
        '~class': ' page-title',
        'itemprop': 'name'
    }) %}

    <h1 {{ block('block_attributes') }}>{{ translated_value|oro_html_strip_tags }}</h1>
{% endblock %}

{% block _product_view_attribute_group_general_attribute_text_sku_widget %}
    {% set attr = layout_attr_defaults(attr, {
        '~class': ' sku'
    }) %}
    <p {{ block('block_attributes') }}>
        {{ 'oro.product.frontend.index.item'|trans }} <span class="sku__code" itemprop="sku">{{ entity.sku|oro_html_strip_tags }}</span>
    </p>
{% endblock %}

{% block _product_view_attribute_group_general_attribute_product_brand_brand_widget %}
    {% set attr = layout_attr_defaults(attr, {'~class': ' brand'}) %}
    <div {{ block('block_attributes') }}>
        {% if label|trans|first != '_' %}
            <span class="product-view-brand">{{ label|trans }}:</span>
        {% endif %}
        <span class="product-view-brand-title" itemprop="brand">{{ block('attribute_localized_fallback_widget') }}</span>
    </div>
{% endblock %}

{% block attribute_group_general_widget %}
    {% set fieldName = block.vars.fieldName|lower %}
    {% set attr = layout_attr_defaults(attr, {'~class': ' product-view__' ~ fieldName} ) %}
    <div {{ block('block_attributes') }}>
        {% if 'attribute_collection' in block_prefixes %}
            {{ block('product_view_attribute_collection_widget') }}
        {% elseif 'attribute_image' in block_prefixes %}
            {{ block('product_view_attribute_image_widget') }}
        {% else %}
            {% if label|trans|first != '_' %}
                <span class="product-view-attribute">{{ label|trans }}:</span>
            {% endif %}
            <span>{{ block_widget(block) }}</span>
        {% endif %}
    </div>
{% endblock %}

{% block attribute_product_images_widget %}
    {% set product = entity %}
    {{ block('_product_view_media_widget') }}
{% endblock %}

{% block _product_js_modules_config_widget %}
    {% import '@OroAsset/Asset.html.twig' as Asset %}
    {{ Asset.js_modules_config({
        'oroui/js/app/views/tab-collection-view': {
            templateClassName: 'nav product-attributes-tabs'
        },
        'oroui/js/app/views/tab-item-view': {
            className: 'product-attributes-tabs__item',
            templateClassName: 'product-attributes-tabs__link'
        }
    }) }}
{% endblock %}

{% block _product_view_line_item_container_widget %}
    {% set attr = layout_attr_defaults(attr, {
        '~class': ' line-item-form',
    }) %}
    {% set children = block_widget(block, {attr: attr}) %}
    {% if children|trim|length %}
        <div {{ block('block_attributes') }}>
            {{ children|raw }}
        </div>
    {% endif %}
{% endblock %}

{% block product_view_attribute_collection_widget %}
    {% if value|length > 0 %}
        {% if label|trans|first != '_' %}
            <div class="product-view__attribute-title">{{ label|trans }}</div>
        {% endif %}
        {{ block('product_view_' ~ block_type ~ '_widget') }}
    {% endif %}
{% endblock %}

{% block product_view_attribute_multiimages_widget %}
    {% import 'OroUIBundle::macros.html.twig' as UI %}
    {% import 'OroProductBundle::image_macros.html.twig' as Image %}

    {% set collection = value %}
    {% set galleryImages = [] %}
    {% for item in collection %}
        {% set galleryImages = galleryImages|merge([{
            src: Image.url(item.file, 'product_gallery_popup'),
            alt: ''
        }]) %}
    {% endfor %}

    {% set popupGalleryAttr = {
        'data-page-component-module': 'oroproduct/js/app/widget/product-popup-gallery-widget',
        'data-page-component-options': {
            bindWithSlider: false,
            galleryImages: galleryImages
        }|json_encode
    } %}

    <div class="product-view__attribute-images" {{ UI.attributes(popupGalleryAttr) }}>
        {%- for item in collection -%}
        <div class="product-view__attribute-images-item" data-trigger-gallery-open data-gallery-image-index="{{ loop.index0 }}">
            <img class="product-view__attribute-image" src="{{ Image.url(item.file, 'product_small') }}"/>
        </div>
        {%- endfor -%}
    </div>
{% endblock %}

{% block product_view_attribute_image_widget %}
    {% import 'OroUIBundle::macros.html.twig' as UI %}
    {% import 'OroProductBundle::image_macros.html.twig' as Image %}

    {% set popupGalleryAttr = {
        'data-page-component-module': 'oroproduct/js/app/widget/product-popup-gallery-widget',
        'data-page-component-options': {
            bindWithSlider: false,
            galleryImages: [{
                src: Image.url(value, 'product_gallery_popup'),
            }]
        }|json_encode
    } %}

    <div {{ UI.attributes(popupGalleryAttr) }}>
        {% if label|trans|first != '_' %}
            <span class="product-view-attribute">{{ label|trans }}:</span>
        {% endif %}
        <span class="product-view__attribute-images-item" data-trigger-gallery-open>
            <img class="product-view__attribute-image" src="{{ Image.url(value, 'product_small') }}"/>
        </span>
    </div>
{% endblock %}

{% block product_view_attribute_multifiles_widget %}
    {{ block_widget(block) }}
{% endblock %}

{% block attribute_group_rest_attribute_widget %}
    <div class="tab-content__wrapper">
        {% if 'attribute_collection' in block_prefixes %}
            {{ block('product_view_attribute_collection_widget') }}
        {% elseif 'attribute_image' in block_prefixes %}
            {{ block('product_view_attribute_image_widget') }}
        {% else %}
            {{ block('attribute_label_widget') }} {{ block_widget(block) }}
        {% endif %}
    </div>
{% endblock %}
